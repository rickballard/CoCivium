name: succession-guardian
on:
  schedule:
    - cron: "37 7 * * *"   # daily ~07:37 UTC (~02:37 Toronto)
  workflow_dispatch: {}
permissions:
  contents: read
  actions: read
  issues: write
jobs:
  check-heartbeat:
    runs-on: ubuntu-latest
    steps:
      - name: Check last user-heartbeat by @rickballard
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const THRESHOLD_DAYS = 366;
            const FILE = 'user-heartbeat.yml';

            const { data: wfs } = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner, repo: context.repo.repo
            });
            const wf = wfs.workflows.find(w => w.path.endsWith('/' + FILE));
            if (!wf) { core.setFailed(`Workflow ${FILE} not found`); return; }

            const runs = await github.paginate(github.rest.actions.listWorkflowRuns, {
              owner: context.repo.owner, repo: context.repo.repo, workflow_id: wf.id, per_page: 100
            });
            const userRuns = runs
              .filter(r => r.triggering_actor?.login?.toLowerCase() === 'rickballard')
              .filter(r => r.status === 'completed' && r.conclusion === 'success')
              .sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

            const last = userRuns[0] ? new Date(userRuns[0].created_at) : null;
            const now = new Date();
            const ageDays = last ? Math.floor((now - last)/(1000*60*60*24)) : Infinity;

            core.setOutput('age_days', String(ageDays));
            core.info(`Last heartbeat: ${last ? last.toISOString() : 'none'} (ageDays=${ageDays})`);

      - name: Open activation issue if overdue
        if: ${{ steps.check.outputs.age_days && fromJSON(steps.check.outputs.age_days) > 366 }}
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Succession â€” Activation (Manifest v1.0)';
            const { data: existing } = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo, state: 'open', labels: 'succession'
            });
            if (existing.find(i => i.title === title)) {
              core.info('Activation issue already open.'); return;
            }
            const body = [
              'Trigger met: no `user-heartbeat` run by @rickballard for > 366 days.',
              '',
              'See **docs/succession-manifest.md** for guidance. No secrets are released; this authorizes the community to proceed under the license.',
              '',
              '_Automated notice from succession-guardian._'
            ].join('\\n');
            await github.rest.issues.create({
              owner: context.repo.owner, repo: context.repo.repo,
              title, body, labels: ['succession','governance']
            });

